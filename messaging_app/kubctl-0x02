#!/usr/bin/env bash
# kubctl-0x02 - deploy blue and green deployments and check logs

set -euo pipefail

echo "Applying blue deployment..."
kubectl apply -f blue_deployment.yaml

echo "Applying service (routes to blue by default)..."
kubectl apply -f kubeservice.yaml

echo "Applying green deployment (side-by-side)..."
kubectl apply -f green_deployment.yaml

echo "Waiting for green pods to be ready..."
kubectl wait --for=condition=available --timeout=120s deployment/messaging-app-green || true

echo "Green pods:" 
kubectl get pods -l version=green

echo "Checking logs for green pods (last 200 lines):"
for pod in $(kubectl get pods -l version=green -o jsonpath='{.items[*].metadata.name}'); do
  echo "--- logs for $pod ---"
  kubectl logs --tail=200 $pod || true
done

echo "To switch traffic from blue to green, edit the Service selector (version: green) or use kubectl patch to update the selector." 
